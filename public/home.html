<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Photos</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="assets/favicon.png"> 
</head>

<body>
    <img src="assets/logo.svg" alt="Bird Pictures Logo" class="logo">
    <p>A log of bird sightings around towns</p>

    <!-- üîπ Species Filter Dropdown -->
    <div class="filter-container">
        <label for="species-filter">Filter by species:</label>
        <select id="species-filter" onchange="filterPhotos()">
            <option value="all">All Species</option>
        </select>
    </div>

    <div id="photo-gallery"></div>

    <a style="color: aliceblue;" href="admin.html">Admin Area</a>
    <script>
        let allPhotos = [];

        function fetchPhotos() {
            fetch("/api/photos")  // ‚úÖ Using the formatted date API
                .then(response => response.json())
                .then(photos => {
                    allPhotos = photos;
                    populateSpeciesFilter(photos);
                    displayPhotos(photos);
                })
                .catch(error => console.error("‚ùå Error fetching photos:", error)); // Improved error message
        }

        function populateSpeciesFilter(photos) {
            const filterDropdown = document.getElementById("species-filter");
            filterDropdown.innerHTML = `<option value="all">All Species</option>`;

            const uniqueSpecies = new Set();
            photos.forEach(photo => {
                if (photo.species_names) {
                    photo.species_names.split(", ").forEach(species => uniqueSpecies.add(species));
                }
            });

            uniqueSpecies.forEach(species => {
                const option = document.createElement("option");
                option.value = species;
                option.textContent = species;
                filterDropdown.appendChild(option);
            });
        }

        function filterPhotos() {
            const selectedSpecies = document.getElementById("species-filter").value;
            if (selectedSpecies === "all") {
                displayPhotos(allPhotos);
            } else {
                const filteredPhotos = allPhotos.filter(photo =>
                    photo.species_names && photo.species_names.includes(selectedSpecies)
                );
                displayPhotos(filteredPhotos);
            }
        }

        function displayPhotos(photos) {
            const gallery = document.getElementById("photo-gallery");
            gallery.innerHTML = "";

            photos.forEach(photo => {
                const photoCard = document.createElement("div");
                photoCard.className = "photo-card";

                // ‚úÖ Format Date
                let formattedDate = "Unknown date";
                if (photo.date_taken) {
                    const dateObj = new Date(photo.date_taken);
                    formattedDate = dateObj.toLocaleDateString("en-GB", {
                        day: "2-digit",
                        month: "long",
                        year: "numeric",
                    });
                }

                // ‚úÖ Format Location
                let formattedLocation = photo.location && photo.location.toLowerCase() !== "unknown" ? `, ${photo.location}` : "";
                const dateLocation = `${formattedDate}${formattedLocation}`;

                let speciesText = photo.species_names !== "Unknown"
                    ? `<p><strong>Species:</strong> ${photo.species_names}</p>`
                    : "<p><strong>Species:</strong> Unknown</p>";

                // ‚úÖ Updated HTML structure with Date + Location at the top-left
                photoCard.innerHTML = `
            <div class="photo-info">${dateLocation}</div>  <!-- ‚úÖ New Date & Location -->
            <img src="${photo.image_filename}" alt="Bird Photo">
            ${speciesText}
        `;

                gallery.appendChild(photoCard);
            });
        }


        document.addEventListener("DOMContentLoaded", fetchPhotos);
    </script>
</body>

</html>